<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" layout:decorate="main"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout">
<head>
    <title>执行计划</title>
</head>
<body>
<div layout:fragment="content">
    <div class="">
        <div class="clearfix"></div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2><i class="fa fa-user"></i> 客户开发计划->执行计划 </h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <br>
                        <form id="forms" class="form-horizontal form-label-left" th:action="@{/exploit/save}"
                              action="/exploit/update" method="post">
                            <label class="text-center col-md-2 col-sm-2 col-xs-2" for="chcId"> 编号 <span
                                    class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" id="chcId" name="chcId" th:value="${chance.chcId}">
                                <p th:text="${chance.chcId}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2" for="chcCustName"> 客户名称 <span
                                    class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcCustName" name="chcCustName"
                                       th:value="${chance.chcCustName}">
                                <p th:text="${chance.chcCustName}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2" for="chcLinkman"> 负责人 <span
                                    class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcLinkman" name="chcLinkman"
                                       th:value="${chance.chcLinkman}">
                                <p th:text="${chance.chcLinkman}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 机会来源
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcSource" name="chcSource"
                                       th:value="${chance.chcSource}">
                                <p th:text="${chance.chcSource}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 成功几率（%） <span
                                    class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcRate" name="chcRate"
                                       th:value="${chance.chcRate}">
                                <p th:text="${chance.chcRate}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 公司电话 <span class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcTel" name="chcTel"
                                       th:value="${chance.chcTel}">
                                <p th:text="${chance.chcTel}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 地区 <span class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcArea" name="chcArea"
                                       th:value="${chance.chcArea}">
                                <p th:text="${chance.chcArea}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 客户等级 <span class="required">*</span>
                            </label>
                            <div class="col-md-4 col-sm-4 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcClientGrade" name="chcClientGrade"
                                       th:value="${chance.chcClientGrade}">
                                <p th:text="${lv.dictItem}"></p>
                            </div>
                            <label class="text-center col-md-2 col-sm-2 col-xs-2"> 概要 <span class="required">*</span>
                            </label>
                            <div class="col-md-10 col-sm-10 col-xs-12 form-group">
                                <input type="hidden" class="form-control" id="chcTitle" name="chcTitle"
                                       th:value="${chance.chcTitle}">
                                <p th:text="${chance.chcTitle}"></p>
                            </div>
                            <div class="form-group">
                                <label class="text-center col-md-2 col-sm-2 col-xs-2"> 机会描述 <span
                                        class="required">*</span>
                                </label>
                                <div class="col-md-10 col-sm-10 col-xs-12">
                                    <input type="hidden" class="form-control" id="chcDesc" name="chcDesc"
                                           th:value="${chance.chcDesc}">
                                    <p th:text="${chance.chcDesc}"></p>
                                </div>
                            </div>

                            <table class="table">
                                <thead>
                                <tr>
                                    <th class=" text-center"> 日期 </th>
                                    <th class=" text-center"> 计划项 </th>
                                    <th class=" text-center"> 执行效果 </th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="plan:${chance.plans}">
                                    <th scope="row" class=" text-center" >
                                        <input type="hidden" class="form-control"
                                               th:value="${plan.plaDate}">
                                        <span th:text="${plan.plaDate}"></span>
                                    </th>
                                    <th scope="row" class=" text-center" >
                                        <input type="hidden" class="form-control"
                                               th:value="${plan.plaTodo}">
                                        <span th:text="${plan.plaTodo}"></span>
                                    </th>
                                    <th scope="row" class=" text-center" th:if="${plan.plaResult != ''&&plan.plaResult != null}">
                                        <input type="hidden" class="form-control"
                                               th:value="${plan.plaResult}">
                                        <span th:text="${plan.plaResult}"></span>
                                    </th>
                                    <td th:if="${plan.plaResult eq ''||plan.plaResult eq null}">
                                        <div class="input-group col-lg-11">
                                            <input type="text" class="form-control col-md-2 col-sm-2 col-xs-2 upplaResult"
                                                   th:value="${plan.plaResult}">
                                            <span class="input-group-btn">
                                                <button type="button" class="btn btn-primary" th:onclick="|upd(this,${plan.plaId})|">保存</button>
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>

                            <div class="form-group">
                                <div class="col-md-6 col-md-offset-3">
                                    <button type="button" class="btn btn-success" th:onclick="|update(${chance.chcId},'t')|">开发成功</button>
                                    <button type="button" class="btn btn-danger" th:onclick="|update(${chance.chcId},'f')|">终止开发</button>
                                    <button type="button" class="btn btn-primary" id="back">返回</button>
                                    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script layout:fragment="js">
    $(document).ready(function () {
        $("#back").on("click", function () {
            window.history.back();
        });
    });
    function upd(text,plaId) {
        if(confirm("你确定保存？")){
            $.ajax({
                type:"GET",
                url:"/crm/plan/upd",
                data:{"plaId":plaId,"plaResult":$(text).parent().prev().val()},
                dataType:"json",
                success:function(data){
                    if(data.delResult == "true"){//删除成功：移除删除行
                        alert("修改成功");
                        location.reload();
                    }
                },
                error:function(data){
                    alert("对不起，删除失败");
                }
            });
        }
    };
    function del(plaId) {
        if (confirm("你确定需要删除该计划吗？")) {
            $.ajax({
                type: "GET",
                url: "/crm/plan/del",
                data: "plaId=" + plaId,
                dataType: "json",
                success: function (data) {
                    if (data.delResult == "true") {//删除成功：移除删除行
                        alert("删除成功");
                        location.reload();
                    }
                },
                error: function (data) {
                    alert("对不起，删除失败");
                }
            });
        }
    };
    function update(chcId,fag) {
        var n = "";
        if(fag=="f"){
            n="你确认要终止该计划吗？";
        }else{
            n="开发成功？";
        }
        if (confirm(n)) {
            $.ajax({
                type: "GET",
                url: "/crm/plan/result",
                data: {"chcId":chcId,"tp":fag},
                dataType: "json",
                success: function (data) {
                    if (data.delResult == "true") {//删除成功：移除删除行
                        if (data.flag=="true"){
                            alert("开发成功，已归档");
                        }else{
                            alert("开发成功，已归档");
                        }
                        location.href="/crm/exploit/list";
                    }
                },
                error: function (data) {
                    alert("出现异常，请联系管理员");
                }
            });
        }
    };
</script>
</html>